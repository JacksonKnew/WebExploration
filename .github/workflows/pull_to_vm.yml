name: pull_to_vm

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main", "setup"]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  pull_run:
    runs-on: ubuntu-latest

    steps:
    - name: pull and run containers on vm
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.VM_KEY }}
        command_timeout: 30m
        script: | 
          docker kill $(docker ps -q)
          docker pull jacksonknew/webapp:client-beta
          docker pull jacksonknew/webapp:server-beta
          docker run -d --rm -p 80:80 webapp:client-beta
          docker run -d --rm -p 3500:3500 webapp:server-beta

